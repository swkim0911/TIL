# 로드 밸런서
로드 밸런서는 들어오는 네트워크 트래픽을 여러 서버에 균등하게 분산시키는 네트워크 장치 또는 소프트웨어 애플리케이션이다.

로드 밸런서는 각 서버의 부하를 완화하고, 시스템 자원을 효율적으로 활용하며, 전체 응답 속도를 향상시킨다.

## 로드 밸런싱의 이점

### 1. 애플리케이션 가용성 (availabilty) 

로드 밸런서는 **서버 문제를 자동으로 감지하고 클라이언트 트래픽을 사용 가능한 서버로 리디렉션하여 시스템의 내결함성(Fault tolerance)을 높인다.**

- Fault Tolerance: 일부 구성요소에 장애(fault)가 발생하더라도 전체 시스템이 중단되지 않고 정상적으로 동작할 수 있는 능력

### 2. 애플리케이션 확장성 (scalability)
증가하는 트래픽 수요를  충족하기 위해 서버나 리소스를 간단하게 추가할 수 있도록 함으로써 로드 밸런서는 수평 확장을 가능하게 한다. 

### 3. 애플리케이션 보안
- 서버의 IP 주소나 구조를 보호함으로써 공격 표면을 축소시킨다. 로드 밸런서는 클라이언트 요청을 대신 받아주는 프록시 역할을 수행함으로써 외부 사용자는 실제 서버의 IP 주소를 알 수 없으며, 로드 밸런서의 공인 IP만 접근할 수 있다. 

- SSL 인증서 관리를 중앙화가 가능하다. 로드 밸런서가 SSL 인증서를 보유하고 SSL/TLS 종료(Termination) 및 암호화 작업을 수행하기 때문에, 각 서버에 개별적으로 인증서를 설치할 필요가 없다. 이를 통해 인증서 관리가 단순해지고 보안이 강화된다.

- WAF(Web Application Firewall) 기능을 통합할 수 있다. 대부분의 L7 로드 밸런서는 WAF를 내장하거나 연동할 수 있으며, 이를 통해 SQL injection, XSS, CSRF 등 애플리케이션 계층 공격을 사전에 차단하여 웹 서비스의 보안을 강화한다.
  
> WAF는 웹 애플리케이션으로 들어오는 HTTP/HTTPS 트래픽을 분석해서, 애플리케이션 계층에서 발생하는 공격을 차단하는 보안 소프트웨어이다. 일반 방화벽은 IP, 포트, 프로토콜을 기준으로 트래픽을 막는다면 WAF는 HTTP 요청의 내용을 보고 공격 여부를 판단한다.
 
## 로드 밸런싱 알고리즘 유형
### 정적 로드 밸런싱
정적 로드 밸런싱 알고리즘은 고정된 규칙을 따르며 현재 서버 상태와 무관하다.

#### 1. 라운드 로빈
클라이언트의 요청을 여러 대의 서버에 순차적으로 분배하는 방식이다. 추가적인 연산 과정 없이 들어온 요청을 빠르게 서버로 분산하는 작업에 집중한 방식이다.

모든 서버의 스펙이 동일하거나 비슷한 경우 사용해 볼 수 있는 알고리즘이다.

#### 2. 가중 라운드 로빈
각 서버마다 처리량(가중치)를 설정한 후 가중치가 높은 서버부터 클라이언트의 요청을 우선적으로 전달하는 방식이다. 주로 서버의 트래픽 처리량이 다른 경우, 즉 특정 서버의 스펙이 더 좋을 경우 가중 라운드 로빈 알고리즘을 사용하게 된다.

#### 3. IP 해시 방식
클라이언트 IP 주소에 대해 해싱을 수행함으로써 어떤 서버로 요청을 전달할지 결정하는 방식이다.

클라이언트의 주소가 변경되지 않는다면 동일한 서버로 요청이 전달되는 것을 항상 보장할 수 있고, 세션 클러스터링 환경(서버들의 세션 동기화 환경)이 구성되어 있지 않다면 주로 해당 알고리즘을 사용한다.

### 동적 로드 밸런싱
트래픽을 배포하기 전에 서버의 현재 상태를 먼저 검사한다.

#### 1. 최소 연결 방식
요청이 들어온 시점에 활성 연결(active connections)이 가장 적은 서버로 새로운 요청을 보낸다.

#### 2. 최소 응답 시간
각 서버의 활성 연결 수(부하)와 응답 속도(성능)을 모두 고려하여, 가장 여유 있고 빠른 서버에 우선적으로 요청을 전달하는 방식이다.

## 로드 밸런서 유형

### 계층 기반 종류

#### a. L4 Load Balancer
OSI 7 Layer에서 4계층인 전송 계층을 기반으로 해서 IP 주소 및 포트 번호를 기반으로 트래픽을 분산할 수 있다.

데이터 패킷의 내용을 검사하지 않으므로 처리 속도가 빠르며 basic NAT 역할을 수행함으로써 클라이언트와 서버 사이에서 IP 주소를 변한하여 클라이언트는 오직 로드밸런서의 public IP만 보게 하고, 내부 서버의 private IP는 외부에 노출되지 않게 한다.

#### b. L7 Load Balancer
OSI 7 Layer에서 7계층인 애플리케이션 계층을 기반으로 하기 때문에 HTTP 헤더와 같은 클라이언트의 요청 정보를 기준으로 특정 서버에서 대한 부하를 분산시키는 로드 밸런서 종류이다.

URL에 따라 트래픽을 분산하거나, HTTP 헤더의 쿠키 값에 따라 트래픽을 분산하는 등 클라이언트의 요청을 보다 세분화하여 서버로 전달할 수 있다.

SSL 연결을 종료(Termination)할 수 있다. 마찬가지로 서버 주소를 숨길 수 있는데, 단지 L4처럼 NAT을 통한 IP 변환이 아니라, HTTP(S) 요청을 대신 받아 재전달하는 프록시 방식으로 숨길 수 있다.

### 참고
- https://aws.amazon.com/what-is/load-balancing
- https://www.geeksforgeeks.org/system-design/types-of-load-balancer