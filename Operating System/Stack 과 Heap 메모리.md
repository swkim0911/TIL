# Stack and Heap Memory
## 스택 메모리
프로그램이 실행될 때, 함수가 호출될 때마다 새롭게 할당되는 메모리 영역이다. 함수가 호출되면 그 함수의 지역 변수, 매게 변수, 참조 변수, 리턴 주소가 스택 영역에 할당된다. 데이터는 call stack 안에서 연속된 블록으로 할당되며 함수 실행이 끝나면 할당된 메모리가 자동으로 해제된다.

### 스택 메모리 할당 특징
메모리에 할당된 스택 영역은 함수가 실행되는 동안에만 유효하다. 각 스레드마다 고유의 스택 영역을 갖고 있기 때문에 힙 메모리보다 thread-safe하며, 메모리 공간이 자동으로 관리되기 때문에 힙 할당보다 속도가 빠르다.

### 스택 메모리 크기
OS는 프로그램 실행 시 각 프로세스에 대해 스택 메모리의 최대 크기를 설정한다. macOS 64bit 환경에서 ```ulimit -s``` 로 확인하면 약 ```8MB```가 기본 제한으로 설정되어 있다.

그리고 JVM(HotSpot)은 OS의 제한 안에서, 새 스레드 생성 시 기본적으로 1MB의 스택 크기를 사용하며 ```-Xss``` 옵션으로 조정 가능하다.

## 힙 메모리
힙 메모리는 힙 자료구조와 관련없으며, 단순히 동적 할당에 사용되는 메모리 공간을 말한다. 객체가 생성될 때 객체 자체는 힙 메모리에 저장되고, 그 객체에 대한 참조는 스택 메모리에 저장된다.

스택 메모리와 달리 함수가 종료되더라도 자동으로 해제되지 않으며, Java나 Python에서는 가비지 컬렉터가 사용하지 않는 메모리를 회수 한다.

### 힙 메모리 할당 특징
수동 할당과 가비지 컬렉션 떄문에 스택 메모리보다 속도가 느리며 힙 메모리는 모든 스레드가 공유하므로 스레드 안정성이 떨어진다.

스택 메모리에는 함수가 끝나면 해당 스택 프레임이 사라지므로, 필요한 메모리 양이 비교적 작고, 힙은 프로그램 실행 도중 동적으로 생성되는 객체들을 저장하기 때문에 일반적으로 스택보다 크기가 크다.

## 스택이 힙보다 더 빠른 이유
스택 메모리는 여러 가지 이유(비교 기준)로 힙 메모리보다 훨씬 빠르다.

#### 메모리 할당과 해제
스택은 LIFO 방식으로 동작해서 CPU는 메모리를 할당하거나 해제할 때 스택 포인터만 위아래(push/pop)로 이동하면 된다. 따라서 메모리 할당과 해제가 예측 가능한 순서를 따르기 때문에 매우 빠르다.

> 스택 포인터는 스택에 추가된 마지막 데이터 요소의 메모리 주소 또는 경우에 따라 스택에서 사용 가능한 첫 번째 주소를 저장하는 레지스터이다.

힙에서 메모리를 할당하려면 OS가 충분히 여유있는 메모리 블록을 찾아야 하며, 이때 시간이 걸린다. 그리고 **메모리 회수시 GC가 사용되지 않는 객체를 찾아 정리해야 하므로 오버헤드가 증가한다.**

그리고 시간이 지남에 따라 메모리 단편화가 발생할 수 있어, 연속된 메모리 블록을 찾기 더 어려워지고 할당 속도가 더 느려진다.

#### 메모리 접근 
스택에 있는 데이터는 메모리에 연속적으로 저장되므로 캐시 지역성이 좋아 스택에 있는 변수에 접근하는 것은 효율적이다. 

힙에 있는 데이터는 동적으로 메모리에 할당되기 때문에, 힙에 있는 데이터는 연속성이 보장되지 않아 캐시 미스와 액세스 시간이 저하될 수 있다.

#### 크기 및 유연성
스택은 스레드당 고정된 크기를 가지며, 일반적으로 힙보다 훨씬 작다. 고정된 크기 덕분에 스택에서 수행되는 작업은 예측 가능하고 더 빠르다. 하지만 이는 유연성이 떨어진다는 것을 말하며, 너무 많은 데이터를 할당하면 ```StackOverflowError```가 발생할 수 있다.

힙은 동적으로 메모리를 할당할 수 있기 때문에 더 크고 유연하다. 하지만 이러한 유연성은 동적 메모리 관리 오버헤드로 인해 성능 저하가 발생한다.

> 유연성: 메모리를 크기/수명 제약 없이 쓸 수 있는가


### 출처
- [Stack vs Heap Memory Allocation](https://www.geeksforgeeks.org/dsa/stack-vs-heap-memory-allocation/)
  
- [Why Is Stack Memory Faster Than Heap Memory](https://medium.com/nerd-for-tech/why-is-stack-memory-faster-than-heap-memory-heres-what-you-need-to-know-a03b63649c35)
  
- [What and Where Are the Memory Stack and Heap?](https://www.baeldung.com/cs/memory-stack-vs-heap)

- [Configuring Stack Sizes in the JVM](https://www.baeldung.com/jvm-configure-stack-sizes)