# 무중단 배포
무중단 배포는 서비스 장애와 배포의 부담을 최소화하기 위해 **운영 중인 서비스를 중단하지 않고 신규 소프트웨어를 배포하는 기술**이다.

무중단 배포의 핵심은 로드밸런서(Load Blanacer)를 통해 연결된 두 개 이상의 (서로 다른 IP, 포트를 가진) 인스턴스에 트래픽을 제어해 배포하는 것이다. 배포 작업이 서비스에 영향을 주지 않도록 하기 위해 고객의 이용량에 따라 인스턴스는 물론 로드밸런서도 다중화 대상이다. 즉, 무중단 배포를 하기 위해서는 고가용성의 시스템 인프라가 구성되어 있어야 한다.

무중단 배포는 크게 두 종류로 나뉜다. **제한된 자원에서 하나씩 배포하여 변경해 나가는 롤링 배포 방식과 현재 사용 중인 버전의 인스턴스 수만큼 새 버전의 인스턴스를 준비해 로드밸런서가 스위칭해주는 블루-그린 배포 방식이 있다.** 여기에 더해 **새로운 버전의 소프트웨어의 모니터링과 검증에 초점을 맞춘 카나리 배포 방식**도 빼놓을 수 없다.

## 롤링 배포(Rolling Deployment)
롤링 배포는 사용 중인 인스턴스 내에서 새 버전을 점진적으로 교체하는 것으로 무중단 배포의 가장 기본적인 방식이다. 서비스 중인 인스턴스 하나를 로드밸런서에서 라우팅하지 않도록 한 뒤, 새 버전을 적용하여 다시 라우팅한다. 이를 반복하여 모든 인스턴스에 새 버전의 애플리케이션을 배포한다.
<p align="center">
  <img style="width:50%; height:auto;" alt="Image" src="https://github.com/user-attachments/assets/91c98499-934e-4a90-aa9a-9db001f36352" />
</p>
<p align="center">
  <sub>https://2cloud.io/blog/zero-downtime-during-deployment</sub>
</p>

장점
- 추가 인프라가 거의 불필요

  - 기존 서버(인스턴스)들을 순차적으로 교체하기 때문에 블루-그린처럼 두 배의 자원이 필요 없다.

- 점진적 교체

  - 인스턴스마다 차례로 배포를 진행하기 때문에 문제가 생기면 쉽게 중단·롤백 가능하다.

단점

- 구버전과 신버전의 공존 문제
  
  - 배포 중 일부 요청은 구버전, 일부는 신버전으로 가서 사용자 경험이 일관되지 않을 수 있다.
  
  - 해결: 세션/상태 외부화, 하위 호환성 유지
    
    - 하위 호환성: 새 버전으로 바꿔도 예전 버전을 쓰던 클라이언트가 문제 없이 계속 쓸 수 있는 상태

- 배포 속도 느림
  
  - 모든 인스턴스를 순차적으로 교체하므로 블루-그린 대비 시간이 오래 걸린다.

## 블루-그린 배포(Blue-Green Deployment)
블루-그린 배포 방식은 블루를 구버전, 그린을 신버전으로 지칭하여 붙여진 이름으로 **운영 환경에 구버전과 동일한 구성의 신버전의 인스턴스를 준비한 후, 로드밸런서를 통해 신버전으로 모든 트래픽을 전환하는 배포 방식이다.**


<p align="center">
  <img width="988" height="1170" alt="Image" src="https://github.com/user-attachments/assets/0802acd2-b6f8-4e27-acd5-24b8da3ff667" />
</p>
<p align="center">
  <sub>https://2cloud.io/blog/zero-downtime-during-deployment</sub>
</p>


장점

- 빠른 전환

  - 새 버전(Green) 준비 후 한 번에 트래픽 전환 → 다운타임이 거의 없다.

- 사전 검증 가능

  - 운영 환경과 동일한 구성에서 미리 테스트 / 트래픽 미러링이 가능하다.

- 즉시 롤백 가능
  - 문제 생기면 바로 이전 버전(Blue)로 되돌릴 수 있다.

단점

- 비용 증가
  - 운영 환경과 동일한 규모의 인프라(Green)가 필요 → 자원 2배.

- 데이터베이스 문제
  - DB는 blue, green 모두 공유하므로 DB 구조 변경은 구버전도 계속 동작할 수 있는 방식(하위 호환성)으로 해야 한다.
  
### 트래픽 미러링
실제 사용자 요청을 원본 서버(현재 운영 중인 버전)으로 보내면서, 그 요청을 복제해서 새로운 서버에도 동시에 보내는 방식이다.

트래픽 미러링을 통해 테스트 데이터가 아닌, 실제 프로덕션 트래픽으로 신 버전을 검증할 수 있으며 배포 전에 성능 문제, 에러율, 리소스 샤용량 등을 미리 관찰할 수 있다.

주의할 점은 쓰기 요청(예: 결제 요청)을 하면 실제로 두 번 결제가 발생할 수 있으니 읽기 전용(GET) 트래픽만 미러링하거나, 신 버전이 결과를 discard하도록 설계해야 한다. 또한, 요청이 두 번 처리되므로 서버나 네트워크에 부하가 증가한다.

트래픽 미러링의 미러링된 서버의 응답은 실제 사용자에게 반환되지 않다 보니, 실제 유저 경험(UX)은 검증할 수 없는 한계가 있다.


## 카나리 배포(Canary Deployment)
카나리 배포는 신버전을 일부 사용자에게만 먼저 배포해서 문제가 없는지 확인한 뒤, 점진적으로 전체 사용자로 확대하는 배포 방식이다.

 옛날 광부들이 유독 가스에 민감한 카나리아 새를 이용해 가스 누출 위험을 감지했던 것에서 유래한 것으로 잠재적 문제 상황을 미리 발견하기 위한 방식이다.

<p align="center">
  <img width="960" height="634" alt="Image" src="https://github.com/user-attachments/assets/1a7fdaa7-52fb-4b7a-82d3-ef8107976b32" />
</p>
<p align="center">
  <sub>https://2cloud.io/blog/zero-downtime-during-deployment</sub>
</p>
장점

- 위험 최소화

  - 문제 발생 시 영향받는 사용자가 적다.
  
- 실제 트래픽 테스트

  - 사전 테스트보다 현실적인 환경에서 검증 가능하다.

단점

- 구버전·신버전 공존

  - 구버전과 신버전 모두 사용자가 경험할 수 있기 때문에, 하위 호환성이 필요하다.

- 배포 속도 느림

  - 전환에 시간이 많이 걸릴 수 있다.
  
### 참고

- [Deployment Strategies With Zero Downtime](https://2cloud.io/blog/zero-downtime-during-deployment)

- [무중단 배포 아키텍처(Zero Downtime Deployment)- 글로벌 서비스 운영의 필수 요소](https://www.samsungsds.com/kr/insights/1256264_4627.html)

- ChatGPT

