## 불변 객체

**불변 객체는 객체가 생성된 후에 내부 상태를 변경할 수 없는 객체**를 말하며, 상태는 객체 인스턴스에 포함된 데이터를 말한다.

예를 들어, Java의 불변 객체에는 setter 함수가 없으며, 상태가 설정되면 객체의 생명주기 동안 동일하게 유지된다.

### 불변 객체 예시

Java의 표준 라이브러리에 있는 불변 클래스는 다음과 같다.

- `String`
- 원시 타입의 래퍼 클래스 (`Integer`, `Double`)
- `BigInteger` 와 `BigDecimal`
- java.time 패키지에 있는 `Date`, `Time` 클래스 (`LocalTime`)

## 불변 객체를 사용하는 이유

- **스레드 안정성**: 멀티 스레드 환경에서 복잡한 동기화 메커니즘없이 안전하게 객체를 사용할 수 있다.
    - 내부 상태가 변하지 않으니 어떤 스레드가 읽어도 항상 같은 값을 갖는다. 또한, 불변 객체는 읽기 전용이므로 여러 스레드가 동시에 접근해도 충돌이 없다.
  
- **`Collections`에서의 신뢰성**: 객체의 불변성은 `HashCode`가 절대로 변하지 않기 때문에 데이터의 무결성이 보장돼서 `HashMap`의 Key나 `HashSet`의 요소로 사용하기 적합하다.
  
- **단순한 추론:** 불변 객체는 내부 상태가 예기치 않게 바뀌지 않기 때문에, 쉽게 이해하고 추론할 수 있다.
  
- **성능 및 메모리 효율성:** 불변 객체는 공유되고 재사용될 수 있어 메모리 오버헤드를 줄여준다.

### 불변 객체 공유 예시

- JVM의 String pool은 `String` 객체를 재사용해서 메모리를 절약하고 성능을 향상시킨다.
    
    ```java
    public static void main(String[] args) {
        String a = "hello";
        String b = "hello";
        System.out.println(a == b);       // true → 같은 객체(풀에서 공유) (== 객체 주소 비교)
    }
    ```
    
- Autoboxing을 하거나, 원시값을 래핑(wrapping)할 때 기존 객체를 재사용하기도 한다. Integer 클래스의 `valueOf` 함수를 보면 -128 ~ 127 정수는 캐싱되어, 재사용한다는 것을 알 수 있다.
    
    ```java
    package java.lang;
    
    // Integer Class
    @IntrinsicCandidate
    public static Integer valueOf(int i) {
        if (i >= IntegerCache.low && i <= IntegerCache.high)
            return IntegerCache.cache[i + (-IntegerCache.low)];
        return new Integer(i);
    }
    ```
    

## 불변 객체의 단점

- **효율성 문제**: 불변 객체를 수정하려면 새로운 인스턴스를 생성해야 해서, 이 과정이 성능 문제로 이어질 수 있다.
    
    예를 들어 반복문 안에서 문자열을 연결할 경우, 매번 새로운 `String` 인스턴스를 생성하게 되는데 이런 경우에는 변경 가능한 `StringBuilder`를 사용하는 게 더 적절하다.
    

## 왜 DTO는 불변 객체로 만들까

그렇다면 왜 Spring에서 DTO를 생성할 때 불변 객체로 만들까?

DTO는 “Data Transfer Object”를 의미하며, 비즈니스 로직은 포함하지 않고 오직 데이터를 표현하는 목적을 갖는 간단한 클래스이다. 즉, 서로 다른 계층 간에 데이터를 전송하거나 네트워크를 통해 데이터를 전달할 때 사용된다.

이렇게 데이터를 전송할 때,** 데이터가 예기치 않게 변경되는 것을 방지하기 위해 불변성이 필요하다.**

아래는 불변 DTO를 구현한 코드이다. 이 클래스의 속성은 getter만 있고, setter는 없어서 객체 생성 시점에만 설정할 수 있다. Java 16 이후에는 `Record` 클래스를 이용해서 쉽게 불변 객체를 쉽게 생성할 수 있게 되었다.

```java
public class CustomerDTO {

    private String name;
    private String email;

    public CustomerDTO(String name, String email) {
        this.name = name;
        this.email = email;
    }

    public String getName() {
        return name;
    }

    public String getEmail() {
        return email;
    }
}
```

### 참고

- https://www.gaurgaurav.com/advancedJava_understandingImmutability
- https://www.baeldung.com/java-immutable-object
- https://zeeshan01.medium.com/dtos-must-be-immutable-ae3fd4b7022f